<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="style.css" />
		<title>Madata Authentication Service</title>
	</head>
	<body>
		<p>Are you sure you want to login with <span id="backend"></span> on <a id="url"></a>?</p>
		<footer class="buttons">
			<button class="yes">Yes, log in</button>
			<button class="no">No, I donâ€™t recognize this site</button>
		</footer>
	</body>

	<script>
		(async () => {
			const params = new URLSearchParams(location.search);

			if (!params.has("state")) {
				document.body.textContent = "This page is not meant to be visited directly.";
				return;
			}

			const yesButton = document.querySelector("button.yes");
			const noButton = document.querySelector("button.no");

			const state = JSON.parse(params.get("state"));
			const url = state.url;
			const backend = state.backend;

			const appURL = document.querySelector("#url");
			appURL.textContent = url;
			appURL.href = url;

			const backendName = document.querySelector("#backend");
			backendName.textContent = backend;

			const code = params.get("code");
			if (!code) {
				return;
			}

			const response = await fetch("/.netlify/functions/auth", {
				method: "POST",
				body: JSON.stringify({ backend, code })
			});
			const json = await response.json();

			yesButton.addEventListener("click", async () => {
				opener.postMessage({ backend, token: json.token }, url);
				window.close();
			});

			noButton.addEventListener("click", async () => {
				window.close();
			});
		})();
	</script>
</html>
